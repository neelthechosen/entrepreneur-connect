{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">Latest Posts</h2>
        <div id="posts-container">
            <!-- Posts will be loaded here via JavaScript -->
        </div>
        <div class="d-flex justify-content-center mt-4">
            <button id="load-more" class="btn btn-primary" style="display: none;">Load More</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    
    function loadPosts(page) {
        fetch(`/api/posts?page=${page}`)
            .then(response => response.json())
            .then(data => {
                const postsContainer = document.getElementById('posts-container');
                
                if (page === 1) {
                    postsContainer.innerHTML = '';
                }
                
                if (data.posts.length === 0 && page === 1) {
                    postsContainer.innerHTML = '<div class="text-center text-muted py-5"><h4>No posts yet</h4><p>Be the first to share something!</p></div>';
                    return;
                }
                
                data.posts.forEach(post => {
                    const postElement = createPostElement(post);
                    postsContainer.appendChild(postElement);
                });
                
                // Show/hide load more button
                const loadMoreButton = document.getElementById('load-more');
                if (data.has_next) {
                    loadMoreButton.style.display = 'block';
                    currentPage = page;
                } else {
                    loadMoreButton.style.display = 'none';
                }
            });
    }
    
    function createPostElement(post) {
        const div = document.createElement('div');
        div.className = 'card mb-4 post';
        div.dataset.postId = post.id;
        
        let imageHtml = '';
        if (post.image) {
            imageHtml = `<img src="{{ url_for('static', filename='uploads/') }}${post.image}" class="card-img-top" alt="Post image">`;
        }
        
        div.innerHTML = `
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <img src="${post.author.profile_picture}" class="rounded-circle me-2" width="40" height="40">
                    <div>
                        <h5 class="card-title mb-0">${post.author.name}</h5>
                        <small class="text-muted">@${post.author.username}</small>
                    </div>
                </div>
                <p class="card-text">${post.content}</p>
                ${imageHtml}
                <div class="mt-3">
                    <small class="text-muted">${post.created_at}</small>
                </div>
                <div class="mt-3 d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-primary like-btn" data-post-id="${post.id}">
                        <i class="bi ${post.user_has_liked ? 'bi-heart-fill' : 'bi-heart'}"></i>
                        <span class="like-count">${post.likes_count}</span>
                    </button>
                    <a href="/post/${post.id}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-chat"></i> ${post.comments_count} Comments
                    </a>
                </div>
            </div>
        `;
        
        return div;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial posts
        loadPosts(1);
        
        // Load more button event
        document.getElementById('load-more').addEventListener('click', function() {
            loadPosts(currentPage + 1);
        });
        
        // Event delegation for like buttons
        document.getElementById('posts-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('like-btn') || e.target.closest('.like-btn')) {
                const button = e.target.classList.contains('like-btn') ? e.target : e.target.closest('.like-btn');
                const postId = button.dataset.postId;
                
                fetch(`/like/${postId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        const icon = button.querySelector('i');
                        const countSpan = button.querySelector('.like-count');
                        
                        if (data.liked) {
                            icon.classList.remove('bi-heart');
                            icon.classList.add('bi-heart-fill');
                        } else {
                            icon.classList.remove('bi-heart-fill');
                            icon.classList.add('bi-heart');
                        }
                        
                        countSpan.textContent = data.likes_count;
                    });
            }
        });
    });
</script>
{% endblock %}
